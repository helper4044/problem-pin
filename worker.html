<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Worker Dashboard ‚Äî Garbage Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {font-family:Poppins,Arial,sans-serif;margin:0;background:#f3fdf4;}
    header {background:#2b8a3e;color:#fff;padding:14px;text-align:center;font-weight:600;}
    .wrap {max-width:1100px;margin:14px auto;padding:12px}
    #map {height:55vh;border-radius:8px}
    .list {margin-top:12px;display:grid;grid-template-columns:1fr 360px;gap:12px}
    .cards {max-height:40vh;overflow:auto;padding:6px}
    .card {background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.06);margin-bottom:10px;text-align:left}
    .card img{width:100%;border-radius:8px;margin-top:8px}
    .btn{padding:8px 12px;border-radius:8px;border:0;color:#fff;font-weight:600;cursor:pointer;margin-right:8px}
    .btn.clean{background:#2b8a3e} .btn.pending{background:#d9534f}
    @media(max-width:900px){ .list{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>üë∑ Worker Dashboard</header>

  <div class="wrap">
    <div id="map"></div>

    <div class="list">
      <div class="cards" id="cardsContainer"></div>
      <div style="padding:12px;background:#fff;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.04)">
        <h3>Controls</h3>
        <button onclick="loadReports()" style="background:#2b8a3e;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer">Refresh</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const BIN_ID = "69149419ae596e708f54b77e";
    const API_KEY = "$2a$10$M82XOQ0SzJJkyIbSqmB.N.P3E4SU23ePZ5D2QBby.ZbLAlwgBK3c6";

    let map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap contributors' }).addTo(map);
    let markers=[];

    async function loadReports(){
      try{
        markers.forEach(m=>map.removeLayer(m));
        markers=[];
        const cards=document.getElementById('cardsContainer');
        cards.innerHTML='Loading...';

        const r=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{headers:{"X-Master-Key":API_KEY}});
        const j=await r.json();
        const reports=j.record?.reports||[];
        if(!reports.length){cards.innerHTML='<p>No reports yet.</p>';return;}
        cards.innerHTML='';
        reports.forEach((r,i)=>{
          const m=L.marker([r.lat,r.lng]).addTo(map);
          m.bindPopup(`<b>${r.comment||'No comment'}</b><br>Status: <b>${r.status}</b>`);
          markers.push(m);

          const c=document.createElement('div');
          c.className='card';
          c.innerHTML=`
            <div><b>Comment:</b> ${r.comment||'No comment'}</div>
            <div><b>Status:</b> <span style="color:${r.status==='Cleaned'?'green':'red'}">${r.status}</span></div>
            <img src="${r.photoUrl}" alt="photo">
            <div><a href="https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}" target="_blank">üó∫Ô∏è Route</a></div>
            <div>
              <button class="btn clean" onclick="updateStatus(${i},'Cleaned')">Cleaned</button>
              <button class="btn pending" onclick="updateStatus(${i},'Pending')">Pending</button>
            </div>`;
          c.onclick=()=>map.setView([r.lat,r.lng],15);
          cards.appendChild(c);
        });
      }catch(e){console.error(e);alert('Error loading reports');}
    }

    async function updateStatus(i,newStatus){
      const r=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{headers:{"X-Master-Key":API_KEY}});
      const j=await r.json();
      const reports=j.record?.reports||[];
      reports[i].status=newStatus;
      await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{
        method:'PUT',
        headers:{"Content-Type":"application/json","X-Master-Key":API_KEY},
        body:JSON.stringify({reports})
      });
      loadReports();
    }

    loadReports();
  </script>
</body>
</html>
